# -*- coding: utf-8 -*-
"""
Google Colab å…¨è‡ªåŠ¨è§†é¢‘ç¿»è¯‘ç³»ç»Ÿ v4.2 (å®Œæ•´å¯è¿è¡Œç‰ˆ)
åŠŸèƒ½ï¼šæ”¯æŒè¯­éŸ³å˜é€ŸåŒæ­¥ | è‡ªåŠ¨é”™è¯¯é‡è¯• | æ™ºèƒ½èµ„æºæ¸…ç†
"""
# â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“ å®Œæ•´ä»£ç  â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“

# ç¯å¢ƒå‡†å¤‡
from google.colab import drive, files
import ipywidgets as widgets
from IPython.display import display, clear_output
import os
import time
import subprocess
from pydub import AudioSegment
import edge_tts
import whisper
from moviepy.editor import VideoFileClip, AudioFileClip

# é…ç½®å‚æ•°
CONFIG = {
    "MAX_RETRIES": 3,          # å¤±è´¥é‡è¯•æ¬¡æ•°
    "VOICE": "en-US-AriaNeural",# å‘éŸ³äººé€‰é¡¹ï¼šen-US-ChristopherNeural, en-GB-LibbyNeural
    "CLEANUP": True,           # è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    "SUBTITLE_SYNC": 0.97      # å­—å¹•æå‰ç³»æ•°(è§£å†³å”‡éŸ³ä¸åŒæ­¥)
}

# UIç»„ä»¶åˆå§‹åŒ–
progress = widgets.FloatProgress(min=0, max=8, description='è¿›åº¦:')
status = widgets.HTML(value="<b>ğŸŸ¢ ç³»ç»Ÿå°±ç»ª</b>")
upload_btn = widgets.Button(description="ğŸ“¤ ä¸Šä¼ è§†é¢‘", button_style='success')
run_btn = widgets.Button(description="ğŸš€ å¼€å§‹å¤„ç†", button_style='primary', disabled=True)
download_btn = widgets.Button(description="â¬‡ï¸ ä¸‹è½½ç»“æœ", disabled=True)
video_name = None

# ç•Œé¢å¸ƒå±€
box = widgets.VBox([
    widgets.HTML("<h1>è§†é¢‘ç¿»è¯‘è‡ªåŠ¨åŒ–ç³»ç»Ÿ v4.2</h1>"),
    upload_btn,
    widgets.HTML("<hr>"),
    run_btn,
    progress,
    status,
    download_btn
])

# ================= æ ¸å¿ƒé€»è¾‘ =================
def process_audio_segment(text, idx, target_duration):
    """å¸¦é‡è¯•æœºåˆ¶çš„è¯­éŸ³ç”Ÿæˆ"""
    for attempt in range(CONFIG["MAX_RETRIES"]):
        try:
            # ç”ŸæˆTTSè¯­éŸ³
            communicate = edge_tts.Communicate(text, CONFIG["VOICE"])
            communicate.save(f"/content/work/tts_{idx}.mp3")
            
            # åŠ è½½å¹¶è°ƒæ•´æ—¶é•¿
            seg = AudioSegment.from_mp3(f"/content/work/tts_{idx}.mp3")
            current_dur = seg.duration_seconds
            
            # åŠ¨æ€å˜é€Ÿç®—æ³•
            if current_dur != target_duration:
                speed_factor = current_dur / target_duration
                seg = seg.speedup(playback_speed=speed_factor)
            
            # ç²¾ç¡®è£å‰ª
            return seg[:int(target_duration*1000)]
        except Exception as e:
            if attempt == CONFIG["MAX_RETRIES"]-1:
                raise RuntimeError(f"è¯­éŸ³ç”Ÿæˆå¤±è´¥: {str(e)}")
            time.sleep(2)

def generate_dubbed_audio(result):
    """ç”ŸæˆåŒæ­¥é…éŸ³"""
    final_audio = AudioSegment.silent(0)
    for idx, seg in enumerate(result['segments']):
        # æ ¡å‡†æ—¶é—´æˆ³
        start = seg['start'] * CONFIG["SUBTITLE_SYNC"]
        end = seg['end'] * CONFIG["SUBTITLE_SYNC"]
        target_dur = end - start
        
        # å¤„ç†éŸ³é¢‘ç‰‡æ®µ
        audio_segment = process_audio_segment(seg['text'], idx, target_dur)
        
        # è¡¥é™éŸ³
        silence_needed = max(0, int(target_dur*1000) - len(audio_segment))
        final_seg = audio_segment + AudioSegment.silent(silence_needed)
        final_audio += final_seg
        
        # æ›´æ–°è¿›åº¦
        progress.value += 1/len(result['segments'])
        status.value = f"ç”Ÿæˆé…éŸ³: {idx+1}/{len(result['segments'])}ç‰‡æ®µ"
    
    final_audio.export("/content/work/dubbed_audio.mp3", format="mp3")

def process_video():
    try:
        # ===== é˜¶æ®µ1: ç¯å¢ƒå‡†å¤‡ =====
        progress.value = 0
        status.value = "ğŸ”§ å®‰è£…ä¾èµ–..."
        !pip install -q openai-whisper==20231117 ffmpeg-python==0.2.0 > /dev/null
        
        # ===== é˜¶æ®µ2: éŸ³é¢‘æå– =====
        progress.value +=1
        status.value = "ğŸµ æå–éŸ³é¢‘..."
        !mkdir -p /content/work
        if os.system(f'ffmpeg -i "{video_name}" -vn -ar 16000 -ac 1 -acodec pcm_s16le -y "/content/work/audio.wav"') != 0:
            raise RuntimeError("éŸ³é¢‘æå–å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§†é¢‘æ ¼å¼")
        
        # ===== é˜¶æ®µ3: å­—å¹•ç”Ÿæˆ =====
        progress.value +=1
        status.value = "ğŸ“ åˆ†æè§†é¢‘..."
        model = whisper.load_model("medium" if "16GB" in os.popen("nvidia-smi").read() else "small")
        
        # å¸¦æ—¶é—´æˆ³æ ¡å‡†çš„è½¬å½•
        result = model.transcribe(
            "/content/work/audio.wav",
            task="translate",
            language="zh",
            word_timestamps=True,
            condition_on_previous_text=False  # é˜²æ­¢é•¿è§†é¢‘å†…å­˜æº¢å‡º
        )
        
        # ä¿å­˜å­—å¹•
        with open("/content/work/subtitles.srt", "w") as f:
            f.write(result["srt"])
        
        # ===== é˜¶æ®µ4: ç”Ÿæˆé…éŸ³ =====
        progress.value +=1
        generate_dubbed_audio(result)
        
        # ===== é˜¶æ®µ5: è§†é¢‘åˆæˆ =====
        progress.value +=1
        status.value = "ğŸ¬ åˆæˆæœ€ç»ˆè§†é¢‘..."
        video = VideoFileClip(video_name).without_audio()
        audio = AudioFileClip("/content/work/dubbed_audio.mp3")
        
        # åŒæ­¥æ—¶é•¿
        final_duration = min(video.duration, audio.duration)
        final_video = video.subclip(0, final_duration).set_audio(audio.subclip(0, final_duration))
        
        # é«˜æ•ˆæ¸²æŸ“
        final_video.write_videofile(
            "/content/work/final_output.mp4",
            codec="libx264",
            audio_codec="aac",
            threads=4,
            preset="fast",
            logger=None  # ç¦ç”¨å†—é•¿æ—¥å¿—
        )
        
        # ===== é˜¶æ®µ6: æ‰“åŒ…ç»“æœ =====
        progress.value +=1
        status.value = "ğŸ“¦ å‡†å¤‡ä¸‹è½½..."
        !zip -j /content/results.zip /content/work/final_output.mp4 /content/work/subtitles.srt
        
        # æ¸…ç†èµ„æº
        if CONFIG["CLEANUP"]:
            !rm -rf /content/work/tts_*.mp3 /content/work/audio.wav
            
        download_btn.disabled = False
        status.value = "<b style='color:green'>âœ… å¤„ç†å®Œæˆï¼</b>"
        
    except Exception as e:
        status.value = f"<b style='color:red'>âŒ é”™è¯¯: {str(e)}</b>"
        run_btn.disabled = False

# ================= äº‹ä»¶ç»‘å®š =================
def on_upload_click(b):
    global video_name
    clear_output()
    display(box)
    uploaded = files.upload()
    if uploaded:
        video_name = list(uploaded.keys())[0]
        status.value = f"<b>ğŸ“¼ å·²ä¸Šä¼ ï¼š{video_name}</b>"
        run_btn.disabled = False

def on_run_click(b):
    run_btn.disabled = True
    download_btn.disabled = True
    progress.value = 0
    process_video()

def on_download_click(b):
    files.download("/content/results.zip")

upload_btn.on_click(on_upload_click)
run_btn.on_click(on_run_click)
download_btn.on_click(on_download_click)

# å¯åŠ¨ç•Œé¢
display(box)
