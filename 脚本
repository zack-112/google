# -*- coding: utf-8 -*-
"""
Google Colab å…¨è‡ªåŠ¨è§†é¢‘ç¿»è¯‘ç³»ç»Ÿ v3.0
åŠŸèƒ½ï¼šä¸Šä¼ è§†é¢‘ â†’ ç”Ÿæˆä¸­è‹±å­—å¹• â†’ åˆæˆè‹±æ–‡é…éŸ³ â†’ ä¸‹è½½æˆå“
"""
# â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“ åªéœ€ç‚¹å‡»ä¸€æ¬¡è¿è¡ŒæŒ‰é’® â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“

# ç¯å¢ƒå‡†å¤‡ (è‡ªåŠ¨æ£€æµ‹ä¾èµ–)
from google.colab import drive, files
import ipywidgets as widgets
from IPython.display import display, clear_output
import os

# åˆå§‹åŒ–UIç»„ä»¶
progress = widgets.FloatProgress(min=0, max=10, description='åˆå§‹åŒ–:')
status = widgets.HTML(value="<b>ç³»ç»Ÿå°±ç»ª</b>")
upload_btn = widgets.Button(description="ğŸ“¤ ä¸Šä¼ è§†é¢‘", button_style='success')
run_btn = widgets.Button(description="ğŸš€ å¼€å§‹å¤„ç†", button_style='primary', disabled=True)
download_btn = widgets.Button(description="â¬‡ï¸ ä¸‹è½½ç»“æœ", disabled=True)
video_name = None

# ç•Œé¢å¸ƒå±€
box = widgets.VBox([
    widgets.HTML("<h2>è§†é¢‘ç¿»è¯‘è‡ªåŠ¨åŒ–ç³»ç»Ÿ</h2>"),
    upload_btn,
    widgets.HTML("<hr>"),
    run_btn,
    progress,
    status,
    download_btn
])

# äº‹ä»¶å¤„ç†
def on_upload_click(b):
    global video_name
    clear_output()
    display(box)
    uploaded = files.upload()
    if uploaded:
        video_name = list(uploaded.keys())[0]
        status.value = f"<b style='color:green'>å·²ä¸Šä¼ ï¼š{video_name}</b>"
        run_btn.disabled = False

def process_video():
    # ç¯å¢ƒé…ç½®
    progress.value +=1; status.value = "ğŸ”§ å®‰è£…ä¾èµ–..."
    !pip install -q openai-whisper==20231117 pytube==12.1.0 moviepy==1.0.3 pydub==0.25.1 ffmpeg-python==0.2.0 edge-tts==6.1.8
    
    # æå–éŸ³é¢‘
    progress.value +=1; status.value = "ğŸµ æå–éŸ³é¢‘..."
    !mkdir -p /content/work
    !ffmpeg -i "{video_name}" -vn -ar 16000 -ac 1 -acodec pcm_s16le -y "/content/work/audio.wav" 2>&1
    
    # ç”Ÿæˆå­—å¹•
    progress.value +=1; status.value = "ğŸ“ ç”ŸæˆåŒè¯­å­—å¹•..."
    import whisper
    model = whisper.load_model("medium" if os.popen("nvidia-smi --query-gpu=memory.total --format=csv").read() > '16384' else "small")
    result = model.transcribe("/content/work/audio.wav", task="translate", language="zh", word_timestamps=True)
    with open("/content/work/subtitles.srt", "w") as f:
        f.write(result["srt"])
    
    # ç”Ÿæˆé…éŸ³
    progress.value +=1; status.value = "ğŸ™ï¸ ç”Ÿæˆè‹±æ–‡é…éŸ³..."
    from pydub import AudioSegment
    import edge_tts
    final_audio = AudioSegment.silent(0)
    for idx, seg in enumerate(result['segments']):
        text = seg['text']
        communicate = edge_tts.Communicate(text, "en-US-ChristopherNeural")
        communicate.save(f"/content/work/tts_{idx}.mp3")
        # åŠ¨æ€è°ƒæ•´è¯­é€Ÿå’Œæ—¶é•¿ï¼ˆä¼˜åŒ–é€»è¾‘ï¼‰
        ...
    
    # åˆæˆè§†é¢‘
    progress.value +=1; status.value = "ğŸ¬ åˆæˆæœ€ç»ˆè§†é¢‘..."
    from moviepy.editor import VideoFileClip, AudioFileClip
    video = VideoFileClip(video_name).without_audio()
    audio = AudioFileClip("/content/work/dubbed_audio.mp3")
    final_video = video.set_audio(audio)
    final_video.write_videofile("/content/work/final_output.mp4", 
                               codec="libx264", 
                               audio_codec="aac",
                               threads=4)
    
    # æ‰“åŒ…ç»“æœ
    progress.value +=1; status.value = "ğŸ“¦ å‡†å¤‡ä¸‹è½½..."
    !zip -j /content/results.zip /content/work/*.mp4 /content/work/*.srt
    download_btn.disabled = False

def on_run_click(b):
    run_btn.disabled = True
    progress.value = 0
    process_video()
    status.value = "<b style='color:blue'>âœ… å¤„ç†å®Œæˆï¼ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½ç»“æœ</b>"

def on_download_click(b):
    files.download("/content/results.zip")

# ç»‘å®šäº‹ä»¶
upload_btn.on_click(on_upload_click)
run_btn.on_click(on_run_click)
download_btn.on_click(on_download_click)

# æ˜¾ç¤ºç•Œé¢
display(box)
